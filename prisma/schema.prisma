generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
  binaryTargets   = ["native", "debian-openssl-3.0.x", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model SessionTemplate {
  id          String   @id @default(uuid())
  name        String
  description String
  prompt      String
  title       String?
  isFavorite  Boolean  @default(false)
  isPrebuilt  Boolean  @default(false)
  tags        String // Stored as CSV string
  workspaceId String?
  workspace   Workspace? @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model KeeperSettings {
  id                         String   @id @default("default")
  isEnabled                  Boolean  @default(false)
  autoSwitch                 Boolean  @default(false)
  checkIntervalSeconds       Int      @default(60)
  inactivityThresholdMinutes Int      @default(10)
  activeWorkThresholdMinutes Int      @default(5)
  messages                   String // JSON
  customMessages             String // JSON
  smartPilotEnabled          Boolean  @default(false)
  supervisorProvider         String   @default("openai")
  supervisorApiKey           String?
  julesApiKey                String?
  supervisorModel            String   @default("gpt-4o")
  contextMessageCount        Int      @default(10)
  resumePaused               Boolean  @default(false)
  userId                     String?
  user                       User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  updatedAt                  DateTime @updatedAt
}

model SupervisorState {
  sessionId                      String   @id
  lastProcessedActivityTimestamp String?
  history                        String? // JSON
  openaiThreadId                 String?
  openaiAssistantId              String?
  updatedAt                      DateTime @updatedAt
}

model KeeperLog {
  id        String   @id @default(uuid())
  sessionId String
  type      String
  message   String
  metadata  String? // JSON
  createdAt DateTime @default(now())
}

model Debate {
  id               String   @id @default(uuid())
  topic            String
  summary          String?
  rounds           String // JSON: DebateRound[]
  history          String // JSON: Message[]
  metadata         String? // JSON: Extra context
  promptTokens     Int      @default(0)
  completionTokens Int      @default(0)
  totalTokens      Int      @default(0)
  workspaceId      String?
  workspace        Workspace? @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

model PluginManifest {
  id           String   @id // e.g., 'jira-integration'
  name         String
  description  String
  author       String
  version      String   @default("1.0.0")
  capabilities String   // JSON array e.g., ["filesystem", "network"]
  configSchema String?  // Optional JSON schema for keys/secrets
  signature    String?  // hex or base64 Ed25519 signature
  publicKey    String?  // Developer's public key
  status       String   @default("active") // pending, active, revoked
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  installations InstalledPlugin[]
}

model InstalledPlugin {
  id          String   @id @default(uuid())
  pluginId    String
  workspaceId String?
  workspace   Workspace? @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  config      String?  // JSON map of user-configured properties
  isEnabled   Boolean  @default(true)
  installedAt DateTime @default(now())
  
  plugin      PluginManifest @relation(fields: [pluginId], references: [id])
}

model PluginAuditLog {
  id                  String   @id @default(uuid())
  pluginId            String
  action              String
  capabilityRequested String
  success             Boolean
  workspaceId         String
  workspace           Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  timestamp           DateTime @default(now())
}

model ProviderTelemetry {
  id                  String   @id @default(uuid())
  workspaceId         String
  provider            String   // e.g. openai, anthropic
  model               String   // e.g. gpt-4o, claude-3-5-sonnet
  promptTokens        Int
  completionTokens    Int
  estimatedCostUSD    Float
  timestamp           DateTime @default(now())
  workspace           Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
}

model RoutingPolicy {
  id                  String   @id @default(uuid())
  workspaceId         String
  taskType            String   // e.g. code_review, fast_chat, deep_reasoning
  preferredProvider   String?
  preferredModel      String?
  costEfficiencyMode  Boolean  @default(false) // If true, ignore 'preferred' if it exceeds budget thresholds
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  workspace           Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, taskType])
}

model SessionTransfer {
  id               String   @id @default(uuid())
  sourceProvider   String
  sourceSessionId  String
  targetProvider   String
  targetSessionId  String?
  status           String   @default("queued") // queued, preparing, exporting, importing, ready, failed
  transferredItems String   @default("{\"activities\": 0, \"files\": 0}") // JSON
  errorReason      String?
  userId           String?
  user             User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspaceId      String?
  workspace        Workspace? @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

// ----------------------------------------------------------------------------
// Multi-Tenant Auth.js (NextAuth) Schema
// ----------------------------------------------------------------------------

model Account {
  id                 String  @id @default(cuid())
  userId             String
  type               String
  provider           String
  providerAccountId  String
  refresh_token      String?
  access_token       String?
  expires_at         Int?
  token_type         String?
  scope              String?
  id_token           String?
  session_state      String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  accounts      Account[]
  sessions      Session[]
  
  // Relations to system entities
  memberships      WorkspaceMember[]
  keeperSettings   KeeperSettings[]
  sessionTransfers SessionTransfer[]
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Workspace {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  maxPluginExecutionsPerDay Int @default(100)
  monthlyBudget Float    @default(100.00)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  members          WorkspaceMember[]
  templates        SessionTemplate[]
  debates          Debate[]
  installedPlugins InstalledPlugin[]
  sessionTransfers SessionTransfer[]
  pluginAudits     PluginAuditLog[]
  telemetry        ProviderTelemetry[]
  routingPolicies  RoutingPolicy[]
}

model WorkspaceMember {
  id          String   @id @default(cuid())
  workspaceId String
  userId      String
  role        String   @default("member") // owner, admin, member

  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, userId])
}
