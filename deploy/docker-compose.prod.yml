version: '3.8'

services:
  # Jules Frontend (Production)
  jules-ui:
    build:
      context: ..
      dockerfile: deploy/Dockerfile
      target: runner
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - SESSION_SECRET=${SESSION_SECRET:-change_me_in_prod}
    depends_on:
      - terminal-server
    networks:
      - jules-network
    restart: always

  # Terminal Server
  terminal-server:
    build:
      context: ../terminal-server
      dockerfile: Dockerfile
      args:
        - BASE_IMAGE=${TERMINAL_BASE_IMAGE:-nvcr.io/nvidia/pytorch:25.11-py3}
    ports:
      - "8080:8080"
    environment:
      - NODE_ENV=production
    volumes:
      - ${REPO_PATH:-../workspace}:/workspace:rw
      - terminal-history:/root/.bash_history
    networks:
      - jules-network
    restart: always

volumes:
  terminal-history:

networks:
  jules-network:
    driver: bridge
