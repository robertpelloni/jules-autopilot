version: "3.8"

services:
  # Jules Frontend (Next.js â€” Development)
  jules-ui:
    build:
      context: ..
      dockerfile: deploy/Dockerfile
      target: dev
    ports:
      - "3002:3000"
    environment:
      - NODE_ENV=development
      - DATABASE_URL=file:/app/prisma/dev.db
      - NEXTAUTH_URL=http://localhost:3002
      - NEXTAUTH_SECRET=dev-secret-change-in-production
    volumes:
      - ..:/app
      - /app/node_modules
      - /app/.next
    depends_on:
      - terminal-server
    networks:
      - jules-network

  # Terminal Server (Node.js + node-pty + Socket.io)
  terminal-server:
    build:
      context: ../terminal-server
      dockerfile: Dockerfile
      args:
        - BASE_IMAGE=${TERMINAL_BASE_IMAGE:-python:3.11-slim-bookworm}
    ports:
      - "8081:8080"
    environment:
      - NODE_ENV=development
    volumes:
      - ${REPO_PATH:-../workspace}:/workspace:rw
      - terminal-history:/root/.bash_history
    networks:
      - jules-network
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETGID
      - SETUID

volumes:
  terminal-history:

networks:
  jules-network:
    driver: bridge
